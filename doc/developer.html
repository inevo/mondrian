<html>
<!--
  == $Id$
  == This software is subject to the terms of the Common Public License
  == Agreement, available at the following URL:
  == http://www.opensource.org/licenses/cpl.html.
  == Copyright (C) 2005-2005 Julian Hyde
  == All Rights Reserved.
  == You must accept the terms of that agreement to use this software.
  -->

<head>
    <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
	<title>Pentaho Analysis Services: Developer's guide</title>
</head>
<body>
<!-- doc2web start -->

<!-- page title -->
<div class="contentheading">Developer's Guide</div>
<!-- end page title -->

<p>By Julian Hyde; last updated July, 2005.</p>

<hr noshade size="1">

<p>There are several ways to get Mondrian running. The easiest is to download a 
binary release, as described in the <a href="install.html">installation guide</a>. 
But you can also build Mondrian from its source code. This document describes 
how to do that, how to learn about Mondrian's inner workings, and the guidelines 
you'll need to follow if you want to contribute to the Mondrian project.</p>

<h2>Getting the source code</h2>

<p>First, you need to get a copy of the source code. You can get the source code 
from SourceForge or from the project's Perforce source server.</p>

<h3>Download the latest release<a name="3_3_Download_the_latest_source_release">&nbsp;</a></h3>

<p>Download the latest <code>mondrian-<i>version</i>.zip</code> from <a href="http://sourceforge.net/projects/mondrian">
SourceForge</a>, and unzip. Now find the <code>mondrian-<i>version</i>-src.zip</code> 
inside this distribution, and unzip it. The directory you unzip this source code to &mdash; 
typically something like <code>C:\open\mondrian</code>
or <code>/usr/local/mondrian-<i>x.y.z</i></code> &mdash; will be denoted <code>
<i>${project.location}</i></code> later in this document.</p>

<h3>Connect to the Perforce source-code server<a name="3_4_Connect_to_the_Perforce_source_code_server">&nbsp;</a></h3>

<p>If you are a mondrian developer, and need to access the latest source code 
and check in changes, you should connect to the Perforce source-code server. If 
you are not a developer, but are interested in getting the latest code, you can 
connect as the 'guest' user.</p>
<ol>
  <li>Download the perforce client from
  <a target="_parent" href="http://www.perforce.com/perforce/loadprog.html">http://www.perforce.com/perforce/loadprog.html</a></li>
  <li>If you have Windows, start the perforce UI (P4Win). (If you are not
  running windows, you will have to use the command-line interface to do the
  following; 'p4 help' should get you started.)</li>
  <li>Choose <code>Settings</code> &gt; <code>Switch Port Client User...</code>;
  the following dialog appears.<blockquote>
    <img border="0" alt="Perforce setup" src="images/perforce_setup.png" width="425" height="258"/>
  </blockquote>
  </li>
  <li>Set <code>Server</code> to <code>perforce.eigenbase.org</code>;
    <code>Port</code> to <code>1666</code>; set <code>User</code> to
your SourceForge username (usually <code>guest</code>, unless you are a commiter 
	to the project); set <code>
Client</code> to your username plus the name of your machine (for
example, <code>guest.jhyde.stilton</code>).</li>
  <li>Choose <code>ClientSpec</code> &gt; <code>New...</code> and
create a client with the same name. Set its root to something like
'C:\' or 'D:\work', and view specification of
    <blockquote>
      <pre>//open/mondrian/... //&lt;&lt;clientname&gt;&gt;/mondrian/...</pre>
    </blockquote>
  </li>
  <li>Sync to head revision.</li>
</ol>

<p>If you are a regular contributor to the Mondrian project, we will give you 
commiting privileges to the source code server. You will be able to add, edit, 
and delete files in the source system, and commit changelists. Usually we ask 
you to prove your worth with a few tasks before welcoming you to the team; contact Julian Hyde for 
more information on how to join the team.</p>

<h2>Building the code</h2>

<p>Next, install a build environment. Install the <a href="#JDK">JDK</a>, <a href="#Ant">Ant</a>, <a href="#Tomcat">Tomcat</a>, <a href="#Xalan">Xalan</a>,
and <a href="#JUnit">JUnit</a>, and set <code>JAVA_HOME</code>, <code>ANT_HOME</code>,
  <code>TOMCAT_HOME</code>, <code>XALAN_HOME</code>, <code>JUNIT_HOME</code> in 
your environment.</p>

<p>Download the latest <code>jpivot-<i>version</i>.war</code> from
the <a target="_parent" href="http://sourceforge.net/projects/jpivot">JPivot project at SourceForge</a> and
save it as <code><i>${project.location}</i>/lib/jpivot.war</code>.</p>

<p>Now build the code, as follows:</p>

<blockquote>
<pre>C:\mondrian&gt; <b>ant</b>
Buildfile: build.xml

sniff:

prepare:

parser:
[javacup] Opening files...
[javacup] Parsing specification from C:\mondrian\src\main\mondrian\olap\Parser.cup...
[javacup] Checking specification...
[javacup] Warning: Terminal &quot;UNKNOWN&quot; was declared but never used
[javacup] Warning: Non terminal &quot;unsigned_integer&quot; was declared but never used
[javacup] Building parse tables...
[javacup] Computing non-terminal nullability...
[javacup] Computing first sets...
[javacup] Building state machine...
[javacup] Filling in tables...
[javacup] Checking for non-reduced productions...
[javacup] Writing parser...
[javacup] Closing files...
[javacup] ------- CUP v0.10k Parser Generation Summary -------
[javacup] 0 errors and 2 warnings
[javacup] 47 terminals, 49 non-terminals, and 100 productions declared,
[javacup] producing 153 unique parse states.
[javacup] 2 terminals declared but not used.
[javacup] 0 non-terminals declared but not used.
[javacup] 0 productions never reduced.
[javacup] 0 conflicts detected (0 expected).
[javacup] Code written to &quot;Parser.java&quot;, and &quot;ParserSym.java&quot;.
[javacup] ---------------------------------------------------- (v0.10k)

generate.resources:
[javac] Compiling 2 source files to D:\open\mondrian\classes
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource.java
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource.properties
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource_en_US.java
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource_en_US.properties
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource_de_DE.java
[resgen] Generating D:\open\mondrian\src\main\mondrian\olap\MondrianResource_de_DE.properties

def:
[xomgen] Writing src\main\mondrian\olap\mondrian.dtd
[xomgen] Writing src\main\mondrian\olap\MondrianDef.java
[xomgen] Done
[copy] Copying 1 file to D:\open\mondrian\lib

compile.java:
[javac] Compiling 791 source files to D:\open\mondrian\classes
[javac] Note: Some input files use or override a deprecated API.
[javac] Note: Recompile with -deprecation for details.

compile.jsp.maybe:

copy.properties:
[copy] Copying 4 files to D:\open\mondrian\classes

compile:

BUILD SUCCESSFUL
Total time: 46 seconds</pre>
</blockquote>

<h2>Installing the database</h2>

<p>Before you run the regression test suite or the web application, you must 
install the standard FoodMart dataset. This is described in the
<a href="install.html#4_Load_the_database">installation guide</a>.</p>

<p>&nbsp;If you got your files from the Perforce server, you can skip the step 
where you download the data sets: you should already have the files <code>demo/access/MondrianFoodMart.mdb</code>
and <code>demo/FoodMartCreateData.zip</code>.</p>

<h2>Running the test suite<a name="6_Run_the_test_suite">&nbsp;</a></h2>

<p>At the command line:</p>
<blockquote>
  <pre>cd <i>${project.location}</i><br>ant test</pre>
</blockquote>

<p>Running the test via the Mondrian Ant build in Eclipse works, too.</p>
<p>Example output:</p>
<blockquote>
  <pre>Buildfile: C:\Documents and Settings\swood\My Documents\perforce\open\mondrian\build.xml

test-postgres:

sniff:

prepare:

parser:
  [javacup] Files are up to date.

compile.xom:

compile.resgen:

generate.resources:
   [resgen] C:\...\src\main\mondrian\olap\MondrianResource.java is up to date
   [resgen] C:\...\src\main\mondrian\olap\MondrianResource.properties is up to date
   [resgen] C:\...\main\mondrian\olap\MondrianResource_en_US.java is up to date
   [resgen] C:\...\src\main\mondrian\olap\MondrianResource_en_US.properties is up to date
   [resgen] C:\...\src\main\mondrian\olap\MondrianResource_de_DE.java is up to date
   [resgen] C:\...\src\main\mondrian\olap\MondrianResource_de_DE.properties is up to date

def:

compile.java:

compile.jsp.maybe:

copy.properties:

compile:

info:
     [echo] ==============================================================
     [echo] | Mondrian configuration info                                |
     [echo] ==============================================================
     [echo] project.location      = C:\...
     [echo] jdk.home              = C:\j2sdk1.4.2_06
     [echo] catalina.home         = ${env.CATALINA_HOME}
     [echo] xalan.home            = ${env.XALAN_HOME}
     [echo] junit.home            = ${env.JUNIT_HOME}
     [echo] weblogic.home         = ${env.WEBLOGIC_HOME}
     [echo] mondrian.foodmart.catalogURL = file:///C:\.../demo/FoodMart.xml
     [echo] ==============================================================

compile.tests:
    [javac] Compiling 28 source files to C:\...\testclasses
    [javac] Note: C:\...\testsrc\main\mondrian\test\ParameterTest.java uses or overrides a deprecated API.
    [javac] Note: Recompile with -deprecation for details.

test-dbms:
     [echo] Connecting to jdbc:postgresql://localhost/FM3
     [java] Mondrian: properties loaded from 'file:/C:/.../mondrian.properties'
     [java] Mondrian: properties loaded from 'file:/C:/../build.properties'
     [java] Mondrian: loaded 4 system properties
     [java] testName: null
     [java] testClass: null
     [java] All 1 thread(s) started.
     [java] [0] .Mondrian: JDBC driver org.postgresql.Driver loaded successfully
     [java] Mondrian: JDBC driver sun.jdbc.odbc.JdbcOdbcDriver loaded successfully
     [java] Mondrian: JDBC driver com.mysql.jdbc.Driver loaded successfully
     [java] Mondrian: JDBC driver oracle.jdbc.OracleDriver loaded successfully
     [java] .......................................
     [java] [40] ........................................
     [java] [80] ........................................
     [java] [120] ........................................
     [java] [160] ........................................
     [java] [200] ........................................
     [java] [240] ........................................
     [java] [280] ........................................
     [java] [320] ........................................
     [java] [360] ........................................
     [java] [400] ........................................
     [java] [440] ........................................
     [java] [480] ........................................
     [java] [520] ........................................
     [java] [560] ........................................
     [java] [600] ..................
     [java] OK (618 tests)
     [java] Time: 711.63
     [java] Normal termination.
BUILD SUCCESSFUL
Total time: 12 minutes 13 seconds
</pre>
</blockquote>
<p>
</p>

<h2>Create, deploy and start the web application</h2>

<p>At the command prompt, type</p>

<blockquote>

	<p><code>ant war</code></p>
</blockquote>

<p>This will create <code>lib/mondrian.war</code>. Copy <code>mondrian.war</code> 
to the <i></i><code><i>TOMCAT_HOME</i>/webapps</code> directory.</p>

<p>Now, start Tomcat and hit <a href="http://localhost:8080/mondrian">http://localhost:8080/mondrian</a>.</p>

<h2>Coding guidelines<a name="7_2_Coding_guidelines">&nbsp;</a></h2>

<p>If you are contributing code, please follow the same guidelines used for the 
rest of the code. (&quot;When in Rome, do as the Romans do.&quot;)</p>

<p>Code content:</p>
<ul>
  <li>Declare variables as near to their first use as possible.</li>
  <li>Don't initialize variables with 'dummy' values just
      to shut up the compiler.</li>
  <li>One declaration per line is recommended.</li>
  <li>Only one top-level class should be defined per java file.</li>
</ul>

<p>Documentation and comments:</p>
<ul>
  <li>Source files must contain copyright and license notices.</li>
  <li>Classes and public methods must have javadoc.</li>
  <li>Write Javadoc comments on
      methods in the present active ('Collects garbage.'), <em>not</em>
      the imperative ('Collect garbage.'), passive ('Garbage is collected.'),
      or future active ('Will collect garbage.').</li>
  <li>When editing HTML documents, please don't use an editor which reformats
      the HTML source (such as Microsoft Word).</li>
</ul>

<p>Spacing and indentation:</p>
<ul>
  <li>Use spaces, not tabs.</li>
  <li>Indentation 4.</li>
  <li>Open braces on the same line as the preceding 'if', 'else', 'while'
      statement, or method or 'class' declaration.</li>
  <li>Use braces even for single-line blocks.</li>
  <li>Try to keep lines shorter than 80 characters.</li>
</ul>

<p>The following images show my spacing and indentation settings in IntelliJ.</p>

<p><img border="0" alt="Code indentation" src="images/code_indentation.png" width="909" height="908"></p>

<p><img border="0" alt="Code spacing" src="images/code_spacing.png" width="776" height="903"></p>

<h2>Learning more about Mondrian<a name="Learning_more_about_Mondrian">&nbsp;</a></h2>

<h3>How Mondrian generates SQL<a name="How_Mondrian_generates_SQL">&nbsp;</a></h3>

<p>If you're feeling mystified where the various SQL statements come
from, here's a good way to learn more. Give it a try, and if you have
more questions I'll be glad to answer them.</p>
 
<p>In a debugger, put a break point in the <code>
<a href="api/mondrian/rolap/RolapUtil.html#executeQuery(java.sql.Connection, java.lang.String, java.lang.String)">RolapUtil.executeQuery()</a></code>
method, and run a
simple query. The easiest way to run a query is to run a junit testcase such as
<a href="api/mondrian/test/BasicQueryTest.html#testSample0()">BasicQueryTest.testSample0()</a>.
The debugger will stop every time a SQL
statement is executed, and you should be able to loop up the call stack to which component is executing the query.</p>
 
<p>I expect that you will see the following phases in the execution:<ul>

<li>One or two SQL queries will be executed as the <code>schema.xml</code> file is read 
(validating calculated members and named sets, resolving default members of 
hierarchies, and such)<li>A few SQL queries will be executed to resolve members as the query
is parsed. (For example, if a query uses <code>[Store].[USA].[CA]</code>, it will
look all members of the <code>[Store Nation]</code> level, then look up all children
of the <code>[USA]</code> member.)

<li>When the query is executed, the axes (slicer, columns, rows) are
executed first. Expect to see more queries on dimension tables when
expressions like <code>[Product].children</code> are evaluated.

<li>Once the axes are populated, the cells are evaluated. Rather than
executing a SQL query per cell, Mondrian makes a pass over all cells
building a list of cells which are not in the cache. Then it builds
and executes a SQL query to fetch all of those cells. If it didn't
manage to fetch all cell values, it will repeat this step until it
does.</li>

</ul></p>

<p>Remember that the purpose of these queries is to populate cache. There are two caches. The dimension cache which maps a member to its children, e.g.</p>

<blockquote><code>[Store].[All Stores]</code>&nbsp;&rarr; <code>{ [Store].[USA], [Store].[Canada], [Store].[Mexico]}</code></blockquote>

<p>The aggregation cache maps a tuple a measure value, e.g.</p>

<blockquote><code>([Store].[USA], [Gender].[F], [Measures].[Unit Sales])</code> 
	&rarr; <code>123,456</code></blockquote>

<p>Once the cache has been populated, the query won't be executed
again. That's why I recommend that you restart the process each time
you run this in the debugger.</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<h2>Appendix A. Product installation instructions<a name="Appendix_A_Product_installation_instructions">&nbsp;</a></h2>

<p>These are the products I used to build mondrian. Install all of the products 
marked 'required'.</p>

<p>In the following, the symbol <code><i>${project.location}</i></code> means the root of your
source tree.</p>

<table style="border-collapse: collapse;" border="1" cellpadding="2" cellspacing="0" id="table1">
  <tbody>
    <tr>
      <th>Product</th>
      <th>Required?</th>
      <th>Version</th>
      <th>Comment</th>
    </tr>
    <tr>
      <td>JDK<a name="JDK">&nbsp;</a></td>
      <td>Yes</td>
      <td>1.4 or later (I use version 1.5.0_08.)</td>
      <td>Available from <a href="http://developer.java.sun.com/" target="_blank">http://developer.java.sun.com/</a>.
          I downloaded <code>jdk-1_5_0_08-windows-i586-p.exe</code>,
          and installed to <code>E:/jdk1.5.0_08</code>, and set <code>JAVA_HOME</code>
          to the same.</td>
    </tr>
    <tr>
      <td>Ant<a name="Ant">&nbsp;</a></td>
      <td>Yes</td>
      <td>1.5 or later&nbsp;</td>
      <td>Available from <a
 href="http://ant.apache.org/bindownload.cgi">http://ant.apache.org/bindownload.cgi</a>.
I downloaded <code>apache-ant-1.6.2-bin.zip</code>, extracted to <code>E:/jakarta-ant-1.6.2</code>,
and set <code>ANT_HOME</code> to the same.</td>
    </tr>
    <tr>
      <td>Tomcat<a name="Tomcat">&nbsp;</a></td>
      <td>Yes</td>
      <td>5.0.25 or later</td>
      <td>Available from <a href="http://jakarta.apache.org/tomcat"
 target="_blank"> http://jakarta.apache.org/tomcat</a>. I downloaded <code>
jakarta-tomcat-5.0.25.zip</code>, extracted to <code>E:/jakarta-tomcat-5.0.25</code>,
and set <code>TOMCAT_HOME</code> to the same.</td>
    </tr>
    <tr>
      <td>Xerces<a name="Xerces">&nbsp;</a></td>
      <td>&nbsp;</td>
      <td>Use the version included with Tomcat</td>
      <td>Xerces is included with Tomcat. If you use a different
version, compatibility issues may arise.</td>
    </tr>
    <tr>
      <td>Xalan<a name="Xalan">&nbsp;</a></td>
      <td>Yes</td>
      <td>2.6.0 or later</td>
      <td>Available from <a href="http://xml.apache.org/xalan-j/"
 target="_blank"> http://xml.apache.org/xalan-j/</a>. I downloaded <code>xalan-j_2_6_0-bin.zip</code>,
extracted to <code>E:/xalan-j_2_6_0</code>, and set <code>XALAN_HOME</code>
to the same.
      <p><b>Important</b>: copy <i><code>XALAN_HOME</code></i><code>/bin/xalan.jar</code>
to <code><i>TOMCAT_HOME</i>/common/endorsed/</code>.</p>
      </td>
    </tr>
    <tr>
      <td>JUnit<a name="JUnit">&nbsp;</a></td>
      <td>Yes</td>
      <td>3.8.1 or later</td>
      <td>Available from <a href="http://www.junit.org/">http://www.junit.org/</a>.
I downloaded <code> junit3.8.1.zip</code>, extracted to <code>E:/junit3.8.1</code>,
and set <code>JUNIT_HOME</code> to the same.</td>
    </tr>
    <tr>
      <td>JavaCUP (parser generator)</td>
      <td>Included with source distribution, as <code>lib/javacup.jar</code>.&nbsp;</td>
      <td>v0.10g (with modifications)</td>
      <td>Available from <a
 href="http://www.cs.princeton.edu/%7Eappel/modern/java/CUP/"
 target="_blank">http://www.cs.princeton.edu/~appel/modern/java/CUP/</a>.
I modified version v.0.10g to add an Ant task, and to output error
messages in a format which Emacs can parse.</td>
    </tr>
  </tbody>
</table>

<p>&nbsp;</p>

<hr noshade size="1"/>
<p>
    Author: Julian Hyde; last updated July, 2005.<br/>
    Version: $Id$
    (<a href="http://p4web.eigenbase.org/open/mondrian/doc/developer.html?ac=22">log&nbsp;</a>)<br/>
    Copyright (C) 2005-2005 Julian Hyde
</p>

<br />

<!-- doc2web end -->

</body>
</html>
