<html>
<!--
  == $Id$
  == This software is subject to the terms of the Common Public License
  == Agreement, available at the following URL:
  == http://www.opensource.org/licenses/cpl.html.
  == (C) Copyright 2001-2002 Kana Software, Inc. and others.
  == All Rights Reserved.
  == You must accept the terms of that agreement to use this software.
  == jhyde, 24 September, 2002
  -->

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>MonRG specification</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css" />
</head>

<body>
<h1>MonRG: Mondrian Resource Generator</h1>
<p>Julian Hyde, October 12<sup><font face="Verdana">th</font></sup>, 2002.</p>
<p>MonRG (the <i><b>Mon</b></i>drian <i><b>R</b></i>esource <i><b>G</b></i>enerator) 
helps you build and maintain internationalized applications in Java. From a 
simple XML file, it generates classes to access those resources in a type-safe 
manner. It is tightly integrated with <a href="http://jakarta.apache.org/ant/">
ANT</a>, to make the development process painless; and it supports a variety of 
schemes to determine the current locale.</p>
<p>Let's take a look at a simple example.</p>
<h2>Example</h2>
<p>The following example shows how you would define a simple resource file, generate 
resource classes from it, and use those classes in your own code.</p>
<h3>Create a resource file</h3>
<p>First, create a resource file like the following, <code>BirthdayResource_en_US.xml</code>:</p>
<blockquote>
  <pre>&lt;?xml version=&quot;1.0&quot; ?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;Resource.xsl&quot; ?&gt;
&lt;resourceBundle locale=&quot;en_US&quot;&gt;
  &lt;message name=&quot;HappyBirthday&quot;&gt;
    &lt;text&gt;Happy Birthday, {0}! You don't look {1,number}.&lt;/text&gt;
  &lt;/message&gt;
  &lt;exception name=&quot;TooYoung&quot; className=&quot;RuntimeException&quot;&gt;
    &lt;text&gt;{0} has not been born yet.&lt;/text&gt;
  &lt;/exception&gt;
&lt;/resourceBundle&gt;</pre>
</blockquote>
<p dir="ltr">The top-level element of a resource file is always a <code>&lt;resourceBundle&gt;</code>, and the only necessary property 
is the <code>locale</code> of the current file. Its children are a mixture of
<code>&lt;message&gt;</code> and <code>&lt;exception&gt;</code> elements. Each must have a
<code>name</code> attribute and a <code>&lt;text&gt;</code> child holding the message 
string.</p>
<h3>Create ANT target</h3>
<p>Now modify your ANT build-file, <code>build.xml</code>, as follows:</p>
<blockquote>
  <pre>&lt;taskdef name=&quot;resgen&quot; classname=&quot;mondrian.resource.ResourceGenTask&quot;&gt;
  &lt;classpath path=&quot;lib/mondrian.jar&quot;/&gt;
&lt;/taskdef&gt;

&lt;target name=&quot;generate.resources&quot;&gt;
  &lt;resgen srcdir=&quot;source&quot;&gt;
    &lt;include name=&quot;happy/BirthdayResource_en_US.xml&quot;/&gt;
  &lt;/resgen&gt;
&lt;/target&gt;

&lt;target name=&quot;compile&quot; depends=&quot;generate.resources&quot;&gt;
  &lt;javac srcdir=&quot;source&quot; destdir=&quot;classes&quot;&gt;
    &lt;include name=&quot;happy/BirthdayResource*.java&quot;/&gt;
  &lt;/javac&gt;
  &lt;copy todir=&quot;classes&quot;&gt;
    &lt;fileset dir=&quot;source&quot; includes=&quot;**/*.properties&quot;/&gt;
  &lt;/copy&gt;
&lt;/target&gt;</pre>
</blockquote>
<p>I have assumed that your Java source files are held in the &quot;<code>source</code>&quot; 
directory, and classes are compiled to <code>classes</code> directory, but this 
ought to be easy to change. If you already have a target to compile Java source 
files, you don't need the &quot;<code>compile</code>&quot; target; just add its contents to your own 
target.</p>
<h3>Compile</h3>
<p>Build as follows. (You need 'ant' on your path, and you will need to edit the 
project.classpath property in <code>build.xml</code>.)</p>
<blockquote>
  <pre>$ ant
Buildfile: build.xml

generate.resources:
[resgen] Generating source\happy\BirthdayResource.java
[resgen] Generating source\happy\BirthdayResource_en_US.java
[resgen] Generating source\happy\BirthdayResource_en_US.properties

compile:
[javac] Compiling 2 source files to classes
[copy] Copying 1 files to classes

BUILD SUCCESSFUL

Total time: 3 seconds</pre>
</blockquote>
<p>Three files are generated.</p>
<p><code>source/happy/BirthdayResource.java</code>:</p>
<blockquote>
  <pre>package happy;
import java.io.IOException;
import java.util.Locale;
import <a href="api/mondrian/resource/package-summary.html">mondrian.resource.*</a>;
class BirthdayResource extends <a href="api/mondrian/resource/ShadowResourceBundle.html">ShadowResourceBundle</a> {
    public BirthdayResource() throws IOException {
    }
    private static String baseName = &quot;happy.BirthdayResource&quot;;
    /**
      * Retrieves the singleton instance of {@link MondrianResource}. If
      * the application has called {@link #setThreadLocale}, returns the
      * resource for the thread's locale.
      */
    public static synchronized BirthdayResource instance() {
        return (BirthdayResource) instance(baseName);
    }
    /**
      * Retrieves the instance of {@link BirthdayResource} for the given locale.
      */
    public static synchronized MondrianResource instance(Locale locale) {
        return (BirthdayResource) instance(baseName, locale);
    }
    /** e: Internal error: {0} */
    public static final <a href="api/mondrian/resource/ResourceDefinition.html">ResourceDefinition</a> HappyBirthday = new <a href="api/mondrian/resource/ResourceDefinition.html">ResourceDefinition</a>(&quot;HappyBirthday&quot;, &quot;Happy Birthday, {0}! You don't look {1,number} at all.&quot;);
    public String getInternal(String p0) {
        return Internal.instantiate(this, new Object[] {p0}).toString();
    }
    public <a href="api/mondrian/resource/ChainableRuntimeException.html">ChainableRuntimeException</a> newInternal(String p0) {
        return new <a href="api/mondrian/resource/ChainableRuntimeException.html">ChainableRuntimeException</a>(Internal.instantiate(this, new Object[] {p0}), null);
    }
    public <a href="api/mondrian/resource/ChainableRuntimeException.html">ChainableRuntimeException</a> newInternal(String p0, Throwable err) {
        return new <a href="api/mondrian/resource/ChainableRuntimeException.html">ChainableRuntimeException</a>(Internal.instantiate(this, new Object[] {p0}), err);
    }
}</pre>
</blockquote>
<p><code>source/happy/BirthdayResource_en_US.java</code>:</p>
<blockquote>
  <pre>package happy;
import java.io.IOException;

public class BirthdayResource_en_US extends BirthdayResource {
    public BirthdayResource_en_US() throws IOException {}
}</pre>
</blockquote>
<p><code>source/happy/BirthdayResource_en_US.properties</code>:</p>
<blockquote>
  <pre>HappyBirthday=Happy Birthday, {0}! You don't look {1,number}.
TooYoung={0} has not been born yet.</pre>
</blockquote>
<p>There are 3 methods generated for each resource; one to retrieve a string, 
and two to create an exception based upon that string.</p>
<p>Tokens such as <code>{0}</code> and <code>{1,number}</code> in the message 
are automatically converted to method parameters of the right type. This means 
that if you ever change the parameters in your error message, or accidentally 
delete it, you code will no longer build. (If your code doesn't compile, you can 
fix the problem immediately; better that than getting a phone call, &quot;I just got 
this really weird error...&quot;, in a few months time.)</p>
<p>Here's how you might use it in your code:</p>
<blockquote>
  <pre>import happy.BirthdayResource;

public class Birthday {
    static void wishHappyBirthday(String name, int age) {
        if (age &lt; 0) {
            throw BirthdayResource.newTooYoung(name);
        }
        System.out.println(BirthdayResource.getHappyBirthday(name, age));
    }
    public static void main(String[] args) {
        wishHappyBirthday(&quot;Fred&quot;, 33);
        wishHappyBirthday(&quot;Wilma&quot;, -3);
    }
}</pre>
</blockquote>
<p>This produces the following output.</p>
<blockquote>
    <pre>Happy Birthday, Fred! You don't look 33.
RuntimeException: Wilma has not been born yet.</pre>
</blockquote>
<p>So there are the basics. That was easy, wasn't it? Now let's look at how you can 
tell the system to switch to another locale, and how you go about producing 
resource files for that locale.</p>
<h2>Of locales and threads</h2>
<p>When you ask for a message, the system needs to know the locale in order to 
get the right translation. There are several strategies for this.</p>
<p>The simplest strategy is to do nothing. Most applications run in the same locale as their 
host machine, and so when the system calls <code>Locale.getDefault()</code>, it 
will return the right answer.</p>
<p>You can switch locale by calling <code>Locale.getDefault(Locale newLocale)</code>, 
but this call will affect other applications running in the same Java Virtual 
Machine, and is not allowed in some application server environments.</p>
<p>MonRG provides a method
<a href="api/mondrian/resource/ShadowResourceBundle.html#setThreadLocale(java.util.Locale)">
<code>ShadowResourceBundle.setThreadLocale(Locale)</code></a> to allow threads 
to have different locales. Threads which are working in a different locale 
should call this method at their entry point. For example:</p>
<blockquote>
  <pre>System.out.println(BirthdayResource.getHappyBirthday(&quot;Fred&quot;, 33));
ShadowResourceBundle.setThreadLocale(Locale.FR);
System.out.println(BirthdayResource.getHappyBirthday(&quot;Pierre&quot;, 22));</pre>
</blockquote>
<p>produces the output</p>
<blockquote>
    <pre>Happy Birthday, Fred! You don't look 33.
Bon anniversaire, Pi&egrave;rre! 22, quel bon &acirc;ge.</pre>
</blockquote>
<p>Threads which have not made this call will remain in the default locale.</p>
<p>This strategy may not be possible if the threading model is complex. Here, 
you should use an explicit resource bundle object:</p>
<blockquote>
  <pre>BirthdayResource myResource = BirthdayResource.getInstance();
System.out.println(myResource.getHappyBirthday(&quot;Fred&quot;, 33));
myResource = BirthdayResource.getInstance(Locale.FR);
System.out.println(myResource.getHappyBirthday(&quot;Pierre&quot;, 22));</pre>
</blockquote>
<p>The problem is that the accessor methods (<code>getHappyBirthday</code>, and so forth) are 
static. To make them non-static, change add <code>static=&quot;false&quot;</code> to the
<code>&lt;resgen&gt;</code> ANT task:</p>
<blockquote>
  <pre>&lt;target name=&quot;generate.resources&quot;&gt;
  &lt;resgen srcdir=&quot;source&quot; <font color="#FF0000"><i><b>static=&quot;false&quot;</b></i></font>&gt;
    &lt;include name=&quot;happy/BirthdayResource_en_US.xml&quot;/&gt;
  &lt;/resgen&gt;
&lt;/target&gt;</pre>
</blockquote>
<p>(Non-static methods are not yet implemented.) </p>
<h2>Translation</h2>
<p>So far, we've just been dealing with one resource file, and you're probably 
wondering why you went to all the trouble of extracting your messages and 
exception strings! Have no fear, there will be more. A typical development 
process goes as follows.</p>
<p>First, you develop your application for a single locale, referred to as the
<dfn><font face="Verdana">base locale</font></dfn>. I have been assuming that 
this American English (<code>en_US</code>), but you can develop in any locale 
you choose.</p>
<p>You create an XML file for this language containing all the messages and 
exceptions used by your application. Developers are often tempted to put in 
hard-coded strings, but MonRG's tight integration with ANT makes it painless to 
modify the XML file and re-generate the wrapper as you go.</p>
<p>So now you have an application in the beta stage. You're written most of the 
code, are getting through the pile of bugs, and would like to translate the 
product into French (<code>fr_FR</code>). Recall that in the above example, we 
were dealing with the following set of files.</p>
<blockquote>
  <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" id="AutoNumber1">
    <tr>
      <th>Source files</th>
      <td valign="top">happy/BirthdayResource_en_US.xml</td>
    </tr>
    <tr>
      <th>Generated files</th>
      <td valign="top">happy/BirthdayResource.java<br>
      happy/BirthdayResource_en_US.java<br>
      happy/BirthdayResource_en_US.properties</td>
    </tr>
    <tr>
      <th>Runtime files</th>
      <td valign="top">happy/BirthdayResource.class<br>
      happy/BirthdayResource_en_US.class<br>
      happy/BirthdayResource_en_US.properties</td>
    </tr>
  </table>
</blockquote>
<p>Do the following steps:</p>
<ol>
  <li>Copy <code>happy/BirthdayResource_en_US.properties</code>&nbsp; to <code>happy/BirthdayResource_fr_FR.properties</code>, 
  and translate the messages as appropriate for the new locale:<blockquote>
  <pre>HappyBirthday=Bon anniversaire, {0}! {1,number}, c'est un bon age.
TooYoung={0} n'est pas encore n&eacute;(e).</pre>
</blockquote>
  <p>&nbsp;</li>
  <li>Add <code>happy/BirthdayResource_fr_FR.properties</code> to the ANT task:<blockquote>
    <pre>&lt;target name=&quot;generate.resources&quot;&gt;
  &lt;resgen srcdir=&quot;source&quot;&gt;
    &lt;include name=&quot;happy/BirthdayResource_en_US.xml&quot;/&gt;
    &lt;include name=&quot;happy/BirthdayResource_fr_FR.properties&quot;/&gt;
   &lt;/resgen&gt;
&lt;/target&gt;</pre>
    </blockquote></li>
   <li>Build.</li>
</ol>
<p>MonRG treats <code>happy/BirthdayResource_fr_FR.properties</code> as a source file. 
It generates <code>happy/BirthdayResource_fr_FR.java</code> from it, and validates that 
every resource in <code>happy/BirthdayResource_fr_FR.properties</code> exists in
<code>happy/BirthdayResource_en_US.xml</code>, and has the same number and types of parameters.</p>
<p>In this multi-language scenario, the source and generated files are as 
follows (new files are shown in <i>italic</i>):</p><blockquote>

  <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" id="AutoNumber1">
    <tr>
      <th>Source files</th>
      <td valign="top" dir="ltr">happy/BirthdayResource_en_US.xml<br>
      <i>happy/BirthdayResource_fr_FR.properties</i></td>
    </tr>
    <tr>
      <th>Generated files</th>
      <td dir="ltr" valign="top">happy/BirthdayResource.java<br>
      happy/BirthdayResource_en_US.java<br>
      happy/BirthdayResource_en_US.properties<br>
      <i>happy/BirthdayResource_fr_FR.java</i></td>
    </tr>
    <tr>
      <th>Runtime files</th>
      <td dir="ltr" valign="top">happy/BirthdayResource.class<br>
      happy/BirthdayResource_en_US.class<br>
      happy/BirthdayResource_en_US.properties<br>
      <i>happy/BirthdayResource_fr_FR.class<br>
      happy/BirthdayResource_fr_FR.properties</i></td>
    </tr>
  </table>
</blockquote>

<p>(Validation is not implemented yet. As well as detecting modified and deleted 
messages, it should also have a mode which reminds us to add new messages.)</p>

<h2>Resource file format</h2>

<blockquote>
<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" id="AutoNumber2">
  <tr>
    <th>Element</th>
    <th>Attributes</th>
  </tr>
  <tr>
    <td><code>&lt;resourceBundle&gt;</code></td>
    <td><p>The top-level element.</p>
    <p>Attributes:</p>
    <ul>
      <li><b><code>locale</code></b> The locale of resources in this file. Required.</li>
      <li><b><code>static</code></b> If true (the defaut), generate static accessor methods; 
      if false, generate dynamic accessor methods. </li>
      <li><b><code>exceptionClassName</code></b> The default class of exception to generate. 
      Must be qualified by package name, unless it is in the package <code>
      java.lang</code>. Not required; default value is &quot;java.lang.RuntimeException&quot;. 
      The <code>className</code> attribute of <code>&lt;exception&gt;</code> overrides 
      this for a specific exception.</li>
    </ul>
    <p>Children:</p>
    <ul>
      <li>Zero or more &lt;message&gt; or &lt;exception&gt; elements.</li>
    </ul>
    </td>
  </tr>
  <tr>
    <td><code>&lt;message&gt;</code></td>
    <td><p>Defines a localizable message.</p>
    <p>Attributes:</p>
    <ul>
      <li><b><code>name</code></b> The identifier of the message. Becomes the name of the 
      property in the generated <code>.properties</code> file. Required, must be 
      unique within the resource file, and must be a valid Java identifer.</li>
    </ul>
    <p>Children:</p>
    <ul>
      <li>A single <code>&lt;text&gt;</code> element, holding the text of the message. </li>
    </ul>
    </td>
  </tr>
  <tr>
    <td>&lt;exception&gt;</td>
    <td>Defines an exception and its associated message.<p>Attributes:</p>
    <ul>
      <li><b><code>name</code></b> The identifier of the exception. Becomes the name of the 
      property in the generated <code>.properties</code> file. Required, must be 
      unique within the resource file, and must be a valid Java identifer.</li>
      <li><b><code>className</code></b> The type of exception to generate. Must be fully 
      qualified,<br>
      unless it is in the package &lt;code&gt;java.lang&lt;/code&gt;. If not<br>
      specified, the resource bundle's default exception class is used.</li>
    </ul>
    <p>Children:</p>
    <ul>
      <li>A single <code>&lt;text&gt;</code> element, holding the text of the message. </li>
    </ul>
    </td>
  </tr>
  <tr>
    <td><code>&lt;text&gt;</code></td>
    <td>The text of the message or exception. Should be in Java message format (see
    <a href="http://java.sun.com/j2se/1.4/docs/api/java/text/MessageFormat.html">
    class java.text.MessageFormat</a> for more details). If the message contains 
    XML special characters such as '&lt;' and '&amp;', you may find it easier to 
    enclose the message in <code>&lt;![CDATA[</code> ... <code>]]&gt;</code>.</td>
  </tr>
</table>
</blockquote>

<h2>resgen ANT task</h2>

<p>The <code>&lt;resgen&gt;</code> task is defined
<a href="api/mondrian/resource/ResourceGenTask.html">here</a>.</p>

<h2>Conclusion</h2>
<p>MonRG helps you build and maintain an internationalized application. Code 
generation helps to leverage the power of the compiler: it detects parameters 
which are missing or of the wrong type, spelling mistakes, and informational 
messages which are being used to describe error conditions.</p>

<h2>About MonRG and Mondrian</h2>

<p>MonRG is a spin-off of the Mondrian project, an open-source OLAP server. The 
source code and binaries are currently only available as part of the Mondrian 
distribution. For more details on Mondrian, go to
<a href="http://sourceforge.net/projects/mondrian">the project home page at 
SourceForge.net</a>, or email <a href="mailto:jhyde@users.sourceforge.net">
Julian Hyde</a>.</p>

<hr>

<table border="0" class="clsStd" width="100%" style="border-collapse: collapse" bordercolor="#111111" cellpadding="0" cellspacing="0">
  <tr>
    <td class="content">
      <a target="_top" href="index.html">Home</a> |
      <a target="_top" href="noframes.html">No frames</a> | This file is<i>
      <a href="http://apoptosis.dyndns.org:8080/open/mondrian/doc/resgen.html">$Id$
      </a></i> (<a href="http://apoptosis.dyndns.org:8080/open/mondrian/doc/resgen.html?ac=22">log</a>)</td>
    <td align="right">
      <a href="http://sourceforge.net">
        <img src="http://sourceforge.net/sflogo.php?group_id=35302&type=1" width="88" height="31" border="0" alt="SourceForge.net Logo">
      </a>
    </td>
  </tr>
</table>
  
</body>
</html>