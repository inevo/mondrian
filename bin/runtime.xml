<!--
  == $Id$
  == This software is subject to the terms of the Common Public License
  == Agreement, available at the following URL:
  == http://www.opensource.org/licenses/cpl.html.
  == (C) Copyright 2002-2003 Kana Software, Inc. and others.
  == All Rights Reserved.
  == You must accept the terms of that agreement to use this software.
  == jhyde, 20 September, 2002
  ==
  == Ant build-file used in runtime installation of mondrian.
  -->

<project name="mondrian" default="test">
  <!-- Properties specified in mondrian.properties override those set in
       the environment. -->
  <property environment="env"/>
  <property file="mondrian.properties"/>
  <property name="name" value="mondrian"/>
  <property name="project.location" location=".."/>
  <property name="lib.location" location="${project.location}/lib"/>
  <property name="weblogic.home" value="${env.WEBLOGIC_HOME}"/>
  <property name="catalina.home" value="${env.CATALINA_HOME}"/>
  <property name="mondrian.foodmart.catalogURL" value="jar:file:/${lib.location}/mondrian.war!/WEB-INF/queries/FoodMart.xml"/>

  <path id="project.classpath">
    <pathelement location="${lib.location}/${name}.jar"/>
    <pathelement location="${catalina.home}/common/lib/servlet.jar"/>
    <pathelement location="${lib.location}/javacup.jar"/>
    <pathelement location="${lib.location}/xalan.jar"/>
    <pathelement location="${lib.location}/junit.jar"/>
    <!-- CLASSPATH must contain xml-apis.jar, xercesImpl.jar, javacup.jar -->
    <pathelement path="${env.CLASSPATH}"/>
    <!-- Weblogic must be after xml-apis.jar and xercesImpl.jar, because it
         contains an incompatible version of xerces. -->
    <pathelement location="${weblogic.home}/lib/weblogic.jar"/>
  </path>

  <target name="test" description="Runs unit tests.">
    <mkdir dir="junit-results"/>
    <echo>Running mondrian tests
Catalog is ${mondrian.foodmart.catalogURL}
JDBC is ${mondrian.foodmart.jdbcURL}
JDBC drivers are ${mondrian.jdbcDrivers}</echo>

    <junit printsummary="yes" fork="yes" haltonfailure="no" >
        <classpath>
            <path refid="project.classpath"/>
        </classpath>
        <jvmarg value="-Dmondrian.jdbcDrivers=${mondrian.jdbcDrivers}"/>
        <jvmarg value="-Dmondrian.test.connectString=Provider=mondrian;Jdbc='${mondrian.foodmart.jdbcURL}';Catalog='${mondrian.foodmart.catalogURL}'"/>
        <formatter type="xml" />

        <test fork="yes" name="mondrian.test.Main" todir="junit-results"/>
    </junit>

    <junitreport todir="junit-results">
      <fileset dir="junit-results">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="junit-results/html"/>
    </junitreport>

    <echo>See results at junit-results/html/index.html.</echo>
  </target>

</project>
